<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¬Ù„Ø© Ø§Ù„Ø¬Ù…Ø§Ù„ Ø§Ù„Ø¹ØµØ±ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary-color: #d4af37;
            --bg-dark: #121212;
            --bg-panel: #1e1e1e;
            --text-light: #e0e0e0;
            --danger-color: #ff4444;
            --success-color: #00c851;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; }
        body { background-color: var(--bg-dark); color: var(--text-light); overflow-x: hidden; }

        /* --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¬Ù„Ø© --- */
        .book-container {
            max-width: 1000px; margin: 20px auto; padding: 40px;
            background: var(--bg-panel); box-shadow: 0 0 30px rgba(0,0,0,0.7);
            border-radius: 2px; border-top: 5px solid var(--primary-color);
            min-height: 90vh; position: relative;
        }
        header { text-align: center; padding-bottom: 20px; border-bottom: 1px solid #333; margin-bottom: 30px; }
        h1 { color: var(--primary-color); font-size: 3rem; margin-bottom: 10px; letter-spacing: 1px; }
        .subtitle { color: #888; font-size: 1.2rem; margin-bottom: 25px; }

        .search-wrapper { position: relative; max-width: 600px; margin: 0 auto 20px auto; display: flex; align-items: center; }
        .search-input { width: 100%; padding: 15px 20px; padding-left: 50px; border-radius: 30px; border: 2px solid #333; background: #151515; color: #fff; outline: none; font-size: 1.1rem; transition: 0.3s; }
        .search-input:focus { border-color: var(--primary-color); box-shadow: 0 0 10px rgba(212, 175, 55, 0.2); }
        .search-btn-icon { position: absolute; left: 15px; background: none; border: none; color: #777; cursor: pointer; font-size: 1.4rem; transition: 0.3s; }

        #public-content { display: block; animation: fadeIn 1s ease; }
        .articles-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .article-card { background: #252525; border-radius: 8px; overflow: hidden; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .article-card:hover { transform: translateY(-5px); }
        .card-img { width: 100%; height: 180px; object-fit: cover; opacity: 0.9; }
        .card-content { padding: 15px; }
        .card-content h3 { font-size: 1.1rem; margin-bottom: 10px; color: var(--primary-color); }
        .card-content p { font-size: 0.9rem; color: #ccc; margin-bottom: 15px; height: 40px; overflow: hidden; text-overflow: ellipsis; }
        .read-more-btn { display: inline-block; padding: 8px 20px; background: transparent; border: 1px solid var(--primary-color); color: var(--primary-color); text-decoration: none; border-radius: 4px; cursor: pointer; transition: 0.3s; font-size: 0.9rem; }
        .read-more-btn:hover { background: var(--primary-color); color: #000; }

        #article-viewer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 3000; overflow-y: auto; padding: 20px; }
        .article-view-content { max-width: 800px; margin: 40px auto; background: #1e1e1e; padding: 30px; border-radius: 10px; position: relative; border: 1px solid #333; }
        .close-article-btn { position: absolute; top: 20px; left: 20px; background: none; border: none; color: #fff; font-size: 2rem; cursor: pointer; z-index: 10; }
        #view-img { width: 100%; height: 300px; object-fit: cover; border-radius: 5px; margin-bottom: 20px; }
        #view-title { color: var(--primary-color); font-size: 2rem; margin-bottom: 20px; }
        #view-text { line-height: 1.8; color: #ddd; font-size: 1.1rem; white-space: pre-line; }

        /* --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© --- */
        #chat-interface { display: none; flex-direction: column; width: 100%; height: 650px; background: #151515; border: 1px solid #333; border-radius: 10px; position: relative; margin-top: 10px; }
        
        .online-users-bar {
            padding: 10px 15px; background: #111; border-bottom: 1px solid #333;
            border-radius: 10px 10px 0 0; display: flex; gap: 10px; overflow-x: auto;
            align-items: center; height: 60px;
        }
        .online-user {
            background: #222; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem;
            white-space: nowrap; display: flex; align-items: center; gap: 6px; border: 1px solid #333;
        }
        .online-dot { width: 8px; height: 8px; background-color: var(--success-color); border-radius: 50%; box-shadow: 0 0 5px var(--success-color); }

        .chat-header { padding: 10px 15px; background: #1a1a1a; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        .message { max-width: 85%; padding: 10px 15px; border-radius: 15px; position: relative; animation: fadeIn 0.3s ease; word-wrap: break-word; font-size: 0.95rem; }
        .message-sender { font-size: 0.75rem; margin-bottom: 4px; font-weight: bold; }
        
        .message img, .message video { max-width: 100%; border-radius: 10px; margin-top: 5px; border: 1px solid #444; }
        .message audio { width: 100%; min-width: 220px; margin-top: 8px; height: 50px; border-radius: 8px; background-color: #f1f3f4; display: block; }
        
        .sticker-msg { background: transparent !important; padding: 0 !important; box-shadow: none !important; }
        .sticker-img { width: 120px; height: 120px; object-fit: contain; animation: pulse 0.5s ease; }

        .timer-bar { height: 3px; background: var(--primary-color); position: absolute; bottom: 0; right: 0; width: 100%; border-radius: 0 0 15px 15px; }

        .chat-tools { background: #1a1a1a; padding: 8px; display: flex; gap: 10px; border-top: 1px solid #333; justify-content: center; align-items: center; }
        .tool-btn { background: none; border: none; font-size: 1.3rem; cursor: pointer; filter: grayscale(1); transition: 0.3s; }
        .tool-btn:hover { filter: grayscale(0); transform: scale(1.2); }

        .chat-input-area { padding: 15px; background: #1a1a1a; display: flex; gap: 10px; align-items: center; border-radius: 0 0 10px 10px; position: relative;}
        #msg-input { flex: 1; text-align: right; background: #252525; border-radius: 25px; padding: 10px 20px; outline: none; color: #fff; border: 1px solid #333;}

        #recording-status { display: none; flex: 1; color: var(--danger-color); font-weight: bold; animation: pulse 1s infinite; text-align: center; }
        #cancel-record-btn { display: none; background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer; }
        #cancel-record-btn:hover { color: var(--danger-color); }

        #record-trigger-btn {
            background: #333; color: #fff; width: 45px; height: 45px; border-radius: 50%; border: none;
            cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
            transition: 0.2s; box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        #record-trigger-btn.active { background: var(--danger-color); }

        #typing-indicator {
            position: absolute; bottom: 70px; right: 20px;
            font-size: 0.8rem; color: var(--primary-color); font-style: italic;
            display: none; animation: fadeIn 0.3s ease; background: rgba(0,0,0,0.7);
            padding: 5px 10px; border-radius: 10px;
        }

        #sticker-picker {
            display: none; position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%);
            width: 300px; height: 350px; background: #222; border: 1px solid #444;
            border-radius: 15px; z-index: 20; flex-direction: column;
        }
        .sticker-tabs { display: flex; border-bottom: 1px solid #444; }
        .sticker-tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; background: #1a1a1a; color: #888; font-size: 0.9rem; }
        .sticker-tab.active { background: #222; color: var(--primary-color); font-weight: bold; }
        .sticker-content { flex: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .sticker-item { width: 100%; cursor: pointer; transition: 0.2s; }
        .sticker-item:hover { transform: scale(1.1); }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; }
        .modal-box { background: #151515; padding: 30px; border-radius: 15px; border: 1px solid var(--primary-color); text-align: right; width: 90%; max-width: 400px; }
        .decoy-input { width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: 1px solid #444; background: #222; color: #fff; outline: none; text-align: center; }
        .decoy-input:disabled { background: #333; color: #555; border-color: #333; cursor: not-allowed; }
        
        .btn-login { padding: 10px 30px; background: var(--primary-color); border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 10px; color: #111; width: 100%; }
        .btn-danger { background: var(--danger-color); color: white; margin-top: 15px; }
        
        .timer-control-group { background: #222; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #333; margin-bottom: 10px; }
        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-weight: bold; color: var(--primary-color); cursor: pointer; }
        input[type=checkbox] { transform: scale(1.5); cursor: pointer; accent-color: var(--primary-color); }

        #emoji-picker { display: none; position: absolute; bottom: 80px; right: 20px; background: #222; border: 1px solid #444; padding: 10px; border-radius: 10px; width: 250px; flex-wrap: wrap; gap: 5px; height: 150px; overflow-y: auto; z-index: 10; }
        .emoji-item { font-size: 1.5rem; cursor: pointer; padding: 5px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div class="book-container">
        <header>
            <h1>Ø£Ø³Ø±Ø§Ø± Ø§Ù„Ø¬Ù…Ø§Ù„ ÙˆØ§Ù„Ù…ÙƒÙŠØ§Ø¬</h1>
            <p class="subtitle">Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø£ÙˆÙ„ Ù„Ù„Ø£Ù†Ø§Ù‚Ø© ÙˆØ§Ù„Ø¬Ø§Ø°Ø¨ÙŠØ© Ø§Ù„Ø¹ØµØ±ÙŠØ©</p>
            
            <div class="search-wrapper" id="search-wrapper">
                <input type="text" id="header-search" class="search-input" placeholder="Ø§Ø¨Ø­Ø«ÙŠ Ø¹Ù† Ù…Ù‚Ø§Ù„ØŒ Ù…Ù†ØªØ¬ØŒ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù…ÙŠ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„..." onkeypress="handleSearchKey(event)">
                <button class="search-btn-icon" onclick="checkSecretCode()">ğŸ”</button>
            </div>
        </header>

        <div id="public-content">
            <div class="articles-grid">
                <div class="article-card">
                    <img src="https://images.unsplash.com/photo-1522337660859-02fbefca4702?w=600" class="card-img">
                    <div class="card-content">
                        <h3>Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„Ù…ÙƒÙŠØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
                        <p>ØªØ¹Ø±ÙÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© Ù„ÙˆØ¶Ø¹ Ù…ÙƒÙŠØ§Ø¬ Ù†Ø§Ø¹Ù… ÙˆØ¬Ø°Ø§Ø¨ Ù„Ù„Ø¹Ù…Ù„.</p>
                        <button class="read-more-btn" onclick="showArticle(1)">Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø²ÙŠØ¯</button>
                    </div>
                </div>
                <div class="article-card">
                    <img src="https://images.unsplash.com/photo-1596462502278-27bfdd403348?w=600" class="card-img">
                    <div class="card-content">
                        <h3>Ø±ÙˆØªÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ÙŠØ© Ø§Ù„Ù„ÙŠÙ„ÙŠ</h3>
                        <button class="read-more-btn" onclick="showArticle(2)">Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø²ÙŠØ¯</button>
                    </div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 50px; border: 1px solid #333; padding: 30px; border-radius: 10px;">
                <h3 style="color: var(--primary-color);">Ø§Ø´ØªØ±ÙƒÙŠ ÙÙŠ Ø§Ù„Ù†Ø´Ø±Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ÙŠØ©</h3>
                <input type="text" class="decoy-input" style="width: 60%;" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
                <button class="btn-login" style="width: 60%;" onclick="alert('Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø´ØªØ±Ø§ÙƒÙƒ!')">Ø§Ø´ØªØ±Ø§Ùƒ</button>
            </div>
        </div>

        <div id="chat-interface">
            <div class="online-users-bar" id="online-users-list">
                <span style="color:#666; font-size:0.8rem;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
            </div>

            <div class="chat-header">
                <h3>Ù…Ø¬Ù„Ø© Ø§Ù„Ø¬Ù…Ø§Ù„ Ù„Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª</h3>
                <div>
                    <button class="tool-btn" onclick="checkSettingsAccess()">âš™ï¸</button> 
                    <button class="tool-btn" onclick="exitChat()">âœ–</button>
                </div>
            </div>
            
            <div class="chat-box" id="chat-box">
                <div class="message" style="background:transparent; border:1px solid #444; align-self:center; color:#888; text-align:center;">
                    Ø§Ù‡Ù„Ø§ ÙˆØ³Ù‡Ù„Ø§ ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø®Ø¯Ù…ØªÙƒÙ…
                </div>
            </div>

            <div id="typing-indicator"></div>

            <div class="chat-tools">
                <button id="record-trigger-btn" title="Ø§Ø¶ØºØ· Ù„Ù„Ø¨Ø¯Ø¡ØŒ Ø§Ø¶ØºØ· Ø§Ø±Ø³Ø§Ù„ Ù„Ù„Ø¥Ù†Ù‡Ø§Ø¡" onclick="startRecordingMode()">ğŸ™ï¸</button>
                
                <button class="tool-btn" onclick="toggleStickers()" title="Ù…Ù„ØµÙ‚Ø§Øª">ğŸ’–</button>
                <button class="tool-btn" onclick="toggleEmoji()" title="Ø¥ÙŠÙ…ÙˆØ¬ÙŠ">ğŸ˜€</button>
                <button class="tool-btn" onclick="triggerUpload('image')">ğŸ“·</button>
                <button class="tool-btn" onclick="triggerUpload('video')">ğŸ¥</button>
            </div>
            
            <div id="emoji-picker"></div>
            
            <div id="sticker-picker">
                <div class="sticker-tabs">
                    <div class="sticker-tab active" onclick="showStickerCategory('romantic')">Ø±ÙˆÙ…Ø§Ù†Ø³ÙŠØ©</div>
                    <div class="sticker-tab" onclick="showStickerCategory('funny')">Ù…Ø¶Ø­ÙƒØ©</div>
                    <div class="sticker-tab" onclick="showStickerCategory('cats')">Ù‚Ø·Ø·</div>
                </div>
                <div class="sticker-content" id="sticker-content"></div>
            </div>
            
            <div class="chat-input-area">
                <button id="cancel-record-btn" title="Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„" onclick="cancelRecording()">ğŸ—‘ï¸</button>
                <div id="recording-status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...</div>

                <input type="text" id="msg-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." disabled>
                <button class="tool-btn" id="send-btn" onclick="handleSendMessageClick()" style="color: var(--primary-color); filter: none;">â¤</button>
            </div>
        </div>
    </div>

    <input type="file" id="upload-image" accept="image/*" hidden onchange="sendFile(this, 'image')">
    <input type="file" id="upload-video" accept="video/*" hidden onchange="sendFile(this, 'video')">
    <input type="file" id="upload-audio" accept="audio/*" hidden onchange="sendFile(this, 'audio')">

    <div id="name-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="color: var(--primary-color); text-align: center;">Ø§Ù„Ù‡ÙˆÙŠØ© Ù…Ø·Ù„ÙˆØ¨Ø©</h3>
            <input type="text" id="username-input" class="decoy-input" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±">
            <button class="btn-login" onclick="setUsername()">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <div id="article-viewer">
        <div class="article-view-content">
            <button class="close-article-btn" onclick="closeArticle()">âœ–</button>
            <img id="view-img" src="" alt="">
            <h2 id="view-title"></h2>
            <p id="view-text"></p>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="color: var(--primary-color); text-align: center; margin-bottom: 20px;">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØºØ±ÙØ©</h3>
            
            <label>ØªØºÙŠÙŠØ± Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠ:</label>
            <input type="text" id="code-setting" class="decoy-input">
            
            <label>ØªØºÙŠÙŠØ± Ø±Ù…Ø² Ø§Ù„Ù…Ø´Ø±Ù (Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª):</label>
            <input type="text" id="admin-code-setting" class="decoy-input" placeholder="Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ 2023">

            <div class="timer-control-group">
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="timer-toggle" onchange="toggleTimerInputState()">
                    ØªÙØ¹ÙŠÙ„ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ø§Ù„Ù…Ø¤Ù‚Øª)
                </label>
                <label style="font-size: 0.9rem; color: #aaa;">ÙˆÙ‚Øª Ø§Ù„Ø­Ø°Ù (Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ):</label>
                <input type="number" id="timer-setting" class="decoy-input" min="1" placeholder="Ù…Ø«Ù„Ø§Ù‹: 5">
            </div>
            
            <div class="timer-control-group">
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="inactivity-toggle" onchange="toggleInactivityInputState()">
                    ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                </label>
                <label style="font-size: 0.9rem; color: #aaa;">ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬ (Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ):</label>
                <input type="number" id="inactivity-setting" class="decoy-input" min="10">
            </div>

            <div style="border-top: 1px solid #333; margin-top: 15px; padding-top: 15px;">
                <button class="btn-login" onclick="saveSettings()">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                <button class="btn-login btn-danger" onclick="deleteAllMessages()">ğŸ—‘ï¸ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</button>
                <button class="btn-login" style="background: #333; color: #ccc; margin-top: 10px;" onclick="closeSettings()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://tpcsjeogotmsyemdzamk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRwY3NqZW9nb3Rtc3llbWR6YW1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1NzA2NzYsImV4cCI6MjA3OTE0NjY3Nn0.kdRdjNv6__5toWNWne9dDW2zWw8uflPDwQQDTjg0Ddo';
        const MEDIA_BUCKET_NAME = 'CHAT_MEDIA'; 

        let supabaseClient;
        try { supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); } catch (e) { console.error(e); }

        let appSettings = { 
            deleteSeconds: 7, 
            inactivityTimeout: 120, 
            entranceCode: "Ù…Ø±Ø­Ø¨Ù©", 
            timerEnabled: true, 
            inactivityEnabled: true,
            adminCode: "2023" 
        };
        let inactivityTimer;
        let username = "";
        let userColor = "#fff";
        
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false; 
        let presenceChannel;
        let hideTypingTimer;

        const articlesData = {
            1: { title: "Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„Ù…ÙƒÙŠØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…ÙŠ", img: "https://images.unsplash.com/photo-1522337660859-02fbefca4702?w=800", text: "Ø§Ù„Ù†Øµ Ù‡Ù†Ø§..." },
            2: { title: "Ø±ÙˆØªÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ÙŠØ© Ø§Ù„Ù„ÙŠÙ„ÙŠ", img: "https://images.unsplash.com/photo-1596462502278-27bfdd403348?w=800", text: "Ø§Ù„Ù†Øµ Ù‡Ù†Ø§..." }
        };

        const stickers = {
            romantic: [
                "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbWw2bXJ6eXJ6eXJ6eXJ6eXJ6eXJ6eXJ6eXJ6eXJ6eXJ6eSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/26BRv0ThflsHCqDrG/giphy.gif",
                "https://media.giphy.com/media/l4pTfx2qLszoacZRS/giphy.gif",
                "https://media.giphy.com/media/3o7TKoWXm3okO1kgHC/giphy.gif",
                "https://media.giphy.com/media/26FLdmIp6wJr91JAI/giphy.gif"
            ],
            funny: [
                "https://media.giphy.com/media/3oEjHAUOqG3lSS0f1C/giphy.gif",
                "https://media.giphy.com/media/10yXFkBJ0MwGQ0/giphy.gif",
                "https://media.giphy.com/media/ZqlvCTNHpqrio/giphy.gif"
            ],
            cats: [
                "https://media.giphy.com/media/JIX9t2j0ZTN9S/giphy.gif",
                "https://media.giphy.com/media/mlvseq9yvZhba/giphy.gif",
                "https://media.giphy.com/media/BzyTuYCmvSORqs1ABM/giphy.gif"
            ]
        };

        window.onload = async function() {
            if(supabaseClient) {
                let { data } = await supabaseClient.from('settings').select().eq('id', 1).single();
                if (data) {
                    updateLocalSettings(data);
                }
                supabaseClient.channel('public:settings').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'settings' }, (payload) => {
                    updateLocalSettings(payload.new);
                    if(document.getElementById('settings-modal').style.display === 'flex') populateSettingsUI();
                }).subscribe();
            }
        };

        function updateLocalSettings(data) {
            appSettings.deleteSeconds = data.delete_seconds;
            appSettings.inactivityTimeout = data.inactivity_timeout;
            appSettings.entranceCode = data.entrance_code;
            appSettings.timerEnabled = data.timer_enabled;
            appSettings.inactivityEnabled = data.inactivity_enabled;
            appSettings.adminCode = data.admin_code;
        }

        function handleSearchKey(e) { if (e.key === 'Enter') checkSecretCode(); }
        function checkSecretCode() {
            const val = document.getElementById('header-search').value.trim();
            if (val === appSettings.entranceCode || val === "2023" || val === "Ù…Ø±Ø­Ø¨9") {
                document.getElementById('header-search').value = ""; 
                enterChatMode();
            } else { alert(`Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­!`); }
        }
        function enterChatMode() {
            document.getElementById('search-wrapper').style.display = 'none';
            document.getElementById('public-content').style.display = 'none';
            document.getElementById('chat-interface').style.display = 'flex';
            document.getElementById('name-modal').style.display = 'flex';
        }
        function setUsername() {
            const nameIn = document.getElementById('username-input').value.trim();
            if (!nameIn) return alert("ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù…!");
            username = nameIn;
            userColor = `hsl(${Array.from(nameIn).reduce((acc, c) => acc + c.charCodeAt(0), 0) % 360}, 70%, 60%)`;
            document.getElementById('name-modal').style.display = 'none';
            document.getElementById('msg-input').disabled = false;
            document.getElementById('msg-input').placeholder = `Ø±Ø³Ø§Ù„Ø© Ù…Ù† ${username}...`;
            
            startInactivityTimer();
            loadRecentMessages();
            startMessageListener();
            setupPresenceAndTyping(); 
        }
        function exitChat() { location.reload(); }

        function setupPresenceAndTyping() {
            if(!supabaseClient) return;
            presenceChannel = supabaseClient.channel('room_01');
            presenceChannel
                .on('presence', { event: 'sync' }, () => { updateOnlineUsersList(presenceChannel.presenceState()); })
                .on('broadcast', { event: 'typing' }, (payload) => {
                    if(payload.payload.user !== username) showTypingIndicator(payload.payload.user);
                })
                .subscribe(async (status) => {
                    if (status === 'SUBSCRIBED') {
                        await presenceChannel.track({ user: username });
                    }
                });
            document.getElementById('msg-input').addEventListener('input', () => {
                presenceChannel.send({ type: 'broadcast', event: 'typing', payload: { user: username } });
                resetInactivityTimer();
            });
        }

        function updateOnlineUsersList(state) {
            const list = document.getElementById('online-users-list');
            list.innerHTML = '';
            const users = [];
            for (const id in state) {
                const user = state[id][0].user;
                if(!users.includes(user)) users.push(user);
            }
            users.forEach(u => {
                const div = document.createElement('div');
                div.className = 'online-user';
                div.innerHTML = `<div class="online-dot"></div> ${u}`;
                list.appendChild(div);
            });
        }

        function showTypingIndicator(user) {
            const ind = document.getElementById('typing-indicator');
            ind.textContent = `${user} ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†...`;
            ind.style.display = 'block';
            clearTimeout(hideTypingTimer);
            hideTypingTimer = setTimeout(() => { ind.style.display = 'none'; }, 3000);
        }

        function toggleStickers() {
            const picker = document.getElementById('sticker-picker');
            const emoji = document.getElementById('emoji-picker');
            emoji.style.display = 'none';
            if (picker.style.display === 'flex') {
                picker.style.display = 'none';
            } else {
                picker.style.display = 'flex';
                showStickerCategory('romantic');
            }
        }

        function showStickerCategory(cat) {
            const content = document.getElementById('sticker-content');
            content.innerHTML = '';
            document.querySelectorAll('.sticker-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            stickers[cat].forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                img.className = 'sticker-item';
                img.onclick = () => { sendMessage(url, 'sticker'); toggleStickers(); };
                content.appendChild(img);
            });
        }

        async function loadRecentMessages() {
            if(!supabaseClient) return;
            const { data } = await supabaseClient.from('messages').select('*').order('created_at', { ascending: true }).limit(50);
            if (data) {
                data.forEach(msg => appendMessageToUI(msg.sender_name, msg.content, msg.type, msg.color, msg.sender_name === username, true));
                scrollToBottom();
            }
        }

        function handleSendMessageClick() {
            if (isRecording) finishRecordingAndSend();
            else sendMessage(document.getElementById('msg-input').value, 'text');
        }

        async function sendMessage(content, type = 'text', finalContent = null) {
            if (!username) return;
            const text = content ? content.trim() : "";
            const msgToSend = finalContent || text;
            if (!msgToSend && type === 'text') return;

            const msgIn = document.getElementById('msg-input');
            if (text === appSettings.adminCode) { openSettings(); msgIn.value = ""; return; }
            msgIn.value = ""; 
            
            if(supabaseClient) {
                await supabaseClient.from('messages').insert([{ sender_name: username, content: msgToSend, type: type, color: userColor }]);
            }
            resetInactivityTimer();
        }
        
        function startMessageListener() {
            if(!supabaseClient) return;
            supabaseClient.channel('public:messages') 
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, (payload) => {
                    const { sender_name, content, type, color } = payload.new;
                    appendMessageToUI(sender_name, content, type, color, sender_name === username, false);
                })
                .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'messages' }, () => {
                    document.getElementById('chat-box').innerHTML = '';
                })
                .subscribe();
        }
        
        function appendMessageToUI(sender, content, type, color, isMine, isHistory) {
            const chatBox = document.getElementById('chat-box');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message';
            msgDiv.style.alignSelf = isMine ? 'flex-end' : 'flex-start';
            
            if (type === 'sticker') msgDiv.classList.add('sticker-msg');
            else {
                msgDiv.style.background = isMine ? '#007bff' : '#2a2a2a';
                msgDiv.style.borderRadius = isMine ? '15px 15px 0 15px' : '15px 15px 15px 0';
            }

            let innerHTML = '';
            if(type !== 'sticker') innerHTML += `<div class="message-sender" style="color:${color}">${sender}</div>`;

            if (type === 'text') innerHTML += `<div>${content}</div>`;
            else if (type === 'image') innerHTML += `<img src="${content}" onload="scrollToBottom()">`;
            else if (type === 'video') innerHTML += `<video controls src="${content}" style="max-height:300px;"></video>`;
            else if (type === 'audio') innerHTML += `<audio controls src="${content}"></audio>`;
            else if (type === 'sticker') innerHTML += `<img src="${content}" class="sticker-img" onload="scrollToBottom()">`;

            msgDiv.innerHTML = innerHTML;

            if (appSettings.timerEnabled && !isHistory) {
                const timerBar = document.createElement('div');
                timerBar.className = 'timer-bar';
                timerBar.style.transition = `width ${appSettings.deleteSeconds}s linear`;
                timerBar.style.width = '100%';
                msgDiv.appendChild(timerBar);
                setTimeout(() => { timerBar.style.width = '0%'; }, 50);
                setTimeout(() => { msgDiv.style.animation = 'fadeOut 0.5s ease'; setTimeout(() => msgDiv.remove(), 500); }, appSettings.deleteSeconds * 1000);
            }
            chatBox.appendChild(msgDiv);
            scrollToBottom();
        }

        async function startRecordingMode() {
            if (!username) return alert("Ø³Ø¬Ù„ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹");
            if (isRecording) return;
            document.getElementById('msg-input').style.display = 'none';
            document.getElementById('recording-status').style.display = 'block';
            document.getElementById('cancel-record-btn').style.display = 'block';
            document.getElementById('record-trigger-btn').classList.add('active');
            audioChunks = [];
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                let options = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? { mimeType: 'audio/webm;codecs=opus' } : { mimeType: 'audio/webm' };
                mediaRecorder = new MediaRecorder(stream, options);
                mediaRecorder.ondataavailable = event => { if (event.data.size > 0) audioChunks.push(event.data); };
                mediaRecorder.start();
                isRecording = true;
            } catch (err) { alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ†"); cancelRecording(); }
        }

        function finishRecordingAndSend() {
            if (!isRecording || !mediaRecorder) return;
            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
                const filePath = `${Date.now()}_voice.webm`;
                if(supabaseClient) {
                    const { data, error } = await supabaseClient.storage.from(MEDIA_BUCKET_NAME).upload(filePath, audioBlob);
                    if (!error) {
                        const { data: urlData } = supabaseClient.storage.from(MEDIA_BUCKET_NAME).getPublicUrl(filePath);
                        sendMessage('', 'audio', urlData.publicUrl);
                    }
                }
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                resetRecordingUI();
            };
            mediaRecorder.stop();
        }

        function cancelRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.onstop = null;
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
            resetRecordingUI();
        }

        function resetRecordingUI() {
            isRecording = false;
            document.getElementById('msg-input').style.display = 'block';
            document.getElementById('recording-status').style.display = 'none';
            document.getElementById('cancel-record-btn').style.display = 'none';
            document.getElementById('record-trigger-btn').classList.remove('active');
        }

        function scrollToBottom() { const box = document.getElementById('chat-box'); box.scrollTop = box.scrollHeight; }
        function triggerUpload(type) { if (!username) return alert("Ø³Ø¬Ù„ Ø§Ø³Ù…Ùƒ!"); document.getElementById(`upload-${type}`).click(); }
        async function sendFile(input, type) {
            if (!input.files[0]) return;
            const file = input.files[0];
            const filePath = `${Date.now()}_${Math.floor(Math.random()*1000)}`;
            if(supabaseClient) {
                const { error } = await supabaseClient.storage.from(MEDIA_BUCKET_NAME).upload(filePath, file);
                if(!error) {
                    const { data } = supabaseClient.storage.from(MEDIA_BUCKET_NAME).getPublicUrl(filePath);
                    sendMessage('', type, data.publicUrl);
                }
            }
            input.value = "";
        }
        
        function toggleTimerInputState() {
            const chk = document.getElementById('timer-toggle').checked;
            document.getElementById('timer-setting').disabled = !chk;
            document.getElementById('timer-setting').style.opacity = chk ? "1" : "0.5";
        }

        function toggleInactivityInputState() {
            const chk = document.getElementById('inactivity-toggle').checked;
            document.getElementById('inactivity-setting').disabled = !chk;
            document.getElementById('inactivity-setting').style.opacity = chk ? "1" : "0.5";
        }

        function checkSettingsAccess() { if (prompt("Ø±Ù…Ø² Ø§Ù„Ù…Ø´Ø±Ù:") === appSettings.adminCode) openSettings(); }
        function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; populateSettingsUI(); }
        function populateSettingsUI() {
            document.getElementById('inactivity-setting').value = appSettings.inactivityTimeout;
            document.getElementById('code-setting').value = appSettings.entranceCode;
            document.getElementById('timer-toggle').checked = appSettings.timerEnabled;
            document.getElementById('timer-setting').value = appSettings.deleteSeconds;
            document.getElementById('inactivity-toggle').checked = appSettings.inactivityEnabled;
            document.getElementById('admin-code-setting').value = appSettings.adminCode;
            toggleTimerInputState();
            toggleInactivityInputState();
        }
        function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
        
        async function saveSettings() {
            const nt = parseInt(document.getElementById('timer-setting').value);
            const ni = parseInt(document.getElementById('inactivity-setting').value);
            const nc = document.getElementById('code-setting').value.trim();
            const on = document.getElementById('timer-toggle').checked;
            const inactOn = document.getElementById('inactivity-toggle').checked;
            const ac = document.getElementById('admin-code-setting').value.trim();

            if(supabaseClient) {
                await supabaseClient.from('settings').upsert({ 
                    id: 1, 
                    delete_seconds: nt, 
                    inactivity_timeout: ni, 
                    entrance_code: nc, 
                    timer_enabled: on,
                    inactivity_enabled: inactOn,
                    admin_code: ac
                });
                alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸"); closeSettings();
            }
        }
        
        async function deleteAllMessages() {
            if(confirm("Ø­Ø°Ù Ø§Ù„ÙƒÙ„ØŸ") && supabaseClient) {
                await supabaseClient.from('messages').delete().neq('id', 0);
                document.getElementById('chat-box').innerHTML = '';
            }
        }
        function showArticle(id) {
            const a = articlesData[id];
            if(a) {
                document.getElementById('view-img').src = a.img;
                document.getElementById('view-title').textContent = a.title;
                document.getElementById('view-text').innerHTML = a.text;
                document.getElementById('article-viewer').style.display = 'block';
            }
        }
        function closeArticle() { document.getElementById('article-viewer').style.display = 'none'; }
        
        const emojiPicker = document.getElementById('emoji-picker');
        ["ğŸ˜€","ğŸ˜‚","ğŸ˜","ğŸ˜","ğŸ¤”","ğŸ˜­","ğŸ˜¡","ğŸ‘","ğŸ‘","â¤ï¸","ğŸ”¥"].forEach(e => {
            const s = document.createElement('span'); s.className='emoji-item'; s.textContent=e;
            s.onclick=()=>{document.getElementById('msg-input').value+=e; toggleEmoji();}
            emojiPicker.appendChild(s);
        });
        function toggleEmoji() { 
            document.getElementById('sticker-picker').style.display = 'none';
            emojiPicker.style.display = emojiPicker.style.display==='flex'?'none':'flex'; 
        }
        
        function startInactivityTimer() { 
            if(!appSettings.inactivityEnabled) return;
            clearTimeout(inactivityTimer); 
            inactivityTimer = setTimeout(() => { alert("Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©"); exitChat(); }, appSettings.inactivityTimeout * 1000); 
        }
        function resetInactivityTimer() { 
            if (document.getElementById('chat-interface').style.display === 'flex') startInactivityTimer(); 
        }
        document.getElementById('msg-input').addEventListener('input', resetInactivityTimer);

    </script>
</body>
</html>
